{% extends "layout.html" %}
{% block content %}
<div class="card p-4">
  <h5 class="fw-bold mb-3">AI 다이어트 코치</h5>

  <div class="mb-3">
    <textarea id="message"
              class="form-control"
              rows="3"
              placeholder="예: 오늘 저녁 뭐 먹는 게 좋을까?"></textarea>
  </div>

  <button class="btn btn-primary" onclick="sendChat()">상담 요청</button>

  <hr>

  <div id="chatResult"></div>
</div>

<script src="/static/js/api.js"></script>

<script>
async function sendChat() {

    const message = document.getElementById("message").value.trim();
    if (!message) {
        alert("메시지를 입력하세요.");
        return;
    }

    const resultDiv = document.getElementById("chatResult");
    resultDiv.innerHTML = "<div class='text-muted'>AI 응답 생성 중...</div>";

    const res = await apiFetch("/chat/api", {
        method: "POST",
        body: JSON.stringify({ message })
    });

    if (!res) return;

    // 리스크 색상 결정
    let color = "success";
    if (res.risk_level === "moderate") color = "warning";
    if (res.risk_level === "high") color = "danger";

    let html = "";

    if (res.risk_level) {
        html += `
            <div class="alert alert-${color}">
                <strong>리스크:</strong> ${res.risk_level}
            </div>
        `;
    }

    if (res.analysis) {
        html += `
            <h6 class="fw-bold">분석</h6>
            <p>${res.analysis}</p>
        `;
    }

    if (res.action_plan && res.action_plan.length > 0) {
        html += `<h6 class="fw-bold">추천 액션</h6><ul>`;
        res.action_plan.forEach(a => {
            html += `<li><strong>${a.title}</strong> - ${a.detail}</li>`;
        });
        html += `</ul>`;
    }

    if (res.calendar_created && res.calendar_created > 0) {
        html += `
            <div class="alert alert-info mt-3">
                AI 추천 일정이 자동으로 추가되었습니다.
            </div>
        `;
    }

    resultDiv.innerHTML = html;
}
</script>
{% endblock %}